{% extends 'main.html' %}
{% block content %}
    {% include 'nav.html' %}
    <script src='{{ url_for("static", filename="js/jquery-3.4.0.min.js") }}'></script>
    <script>
        $(document).ready(function () {
            console.log('---------- signIn & signOut loaded')
                console.log('signInButton Pressed... HIDE')
                $('#signInButton').toggle();
        });
    </script>
    <nav aria-label='breadcrumb'>
        <ol class='breadcrumb'>
            <li class='breadcrumb-item active' aria-current='page'><a href="{{ url_for('catalog_routes.show_catalog') }}">Home</a></li>
            <li class='breadcrumb-item active' aria-current='page'>Login</li>
        </ol>
    </nav>

    <div class='flash'>
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <ul>
                    {% for message in messages %}
                        <li><strong> {{ message }} </strong></li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
    </div> <!-- /.flash -->

    <div class='container'>
        <h1 class='main_page_title text-center'>LOGIN</h1>
        <div class='row d-flex justify-content-center login_div'>

            <div class='col col-md-6 align-items-center'>
                <form action='#' method='POST'>
                    <div class='form-group'>
                        <label for='username'>Username</label>
                        <input type='text' class='form-control' name='username' aria-describedby='userHelp'
                               placeholder='Username'/>
                        <small id='userHelp' class='form-text text-muted'>We'll never share your user information
                        </small>
                    </div> <!-- /.form-group -->
                    <div class='form-group'>
                        <label for='password'>Password</label>
                        <input type='password' class='form-control' name='password' placeholder=''/>
                    </div> <!-- /.form-group -->
                    <button type='submit' class='btn btn-outline-success' id='submit' type='submit'>
                        <span class="glyphicon glyphicon-cutlery" aria-hidden="true"></span>
                        Login
                    </button>
                </form>
            </div> <!-- /.col -->
        </div> <!-- /.row -->
        <div id='result' class='d-flex'></div>

        <div class='row d-flex justify-content-center login_div'>
            <!--<div class='col col-md-3 align-items-center'>-->
                <script src='{{ url_for("static", filename="js/jquery-3.4.0.min.js") }}'></script>
                <!-- ****************** -------------- ********************** -------------- ******************
                     ****************** -------------- GOOGLE SIGN_IN - START -------------- ******************
                     ****************** -------------- ********************** -------------- ****************** -->
                <script src="https://apis.google.com/js/platform.js?onload=start"></script>
                <script>
                   gapi.load('auth2', function () {
                       auth2 = gapi.auth2.init({
                           client_id: '{{ gmail_client_id }}'
                       });
                    });
                </script>
                <button type="button" class="btn btn-outline-danger" id='signInButton_google'>
                    <i class='fab fa-google'></i>  Login with Google
                </button>

                <script>
                    // <!-- GOOGLE SIGN IN -->
                    $('#signInButton_google').click(function () {
                        $('#signInButton_google').attr('style', 'display: none');
                        auth2.grantOfflineAccess({'redirect_uri': 'postmessage'}).then(signInCallback);
                    });
                    // <!-- GOOGLE SIGN IN -->

                    // <!-- GOOGLE SIGN OUT -->
                    $('#signOutButton').click(function () {
                        let auth2 = gapi.auth2.getAuthInstance();
                        // Show the sign-in button now that the user is authorized
                        $('#signInButton').attr('style', 'display: block');
                        auth2.signOut().then(function () {
                            console.log('User signed out.');
                        });
                    });

                    function logout() {
                        let auth2 = gapi.auth2.getAuthInstance();
                        // Show the sign-in button now that the user is authorized
                        $('#signInButton').attr('style', 'display: block');
                        auth2.signOut().then(function () {
                            console.log('User signed out.');
                        });
                    }

                    // <!-- END GOOGLE SIGN_OUT -->

                    function signInCallback(json) {
                        console.log('--------------- inside callback function ---------------');
                        console.log(json);
                        // authResult = JSON.parse(json);
                        authResult = json;
                        if (authResult['code']) {
                            // Hide the sign-in button now that the user is authorized
                            $('#signInButton_google').attr('style', 'display: none');
                            // Send the one-time-use code to the server, if the server responds, write a 'login successful' message to the web page and then redirect back to the main restaurants page
                            $.ajax({
                                type: 'POST',
                                url: '/login/google?state={{ state }}',
                                processData: false,
                                data: authResult['code'],
                                contentType: 'application/octet-stream; charset=utf-8',
                                success: function (result) {
                                    // Handle or verify the server response if necessary.
                                    if (result) {
                                        $('#result').html('<div class="alert-success" role="alert"><strong>Login Successful!</strong>   Redirecting...</div>');
                                        setTimeout(function () {
                                            window.location.href = '/catalog/' // "/catalog/private/";
                                        }, 2000);
                                    } else if (authResult['error']) {
                                        console.log('There was an error: ' + authResult['error']);
                                    } else {
                                        $('#result').html('Failed to make a server-side call. Check your configuration and console.');
                                    }
                                }
                            });
                        }
                    }
                </script>
                <script>
                    $(document).ready(function () {
                        console.log('signOutButton Trigger Click...');
                        // validate if style class is hidden
                        console.log('$(signInButton_google).attr(display): ', $('#signInButton_google').attr('display'));
                        if ($('#signInButton_google').attr('display') === 'none') {
                            logout();
                        }
                    });
                </script>
            <!--</div> !-- /.col -->
            <!-- ****************** -------------- GOOGLE SIGN_IN - END -------------- ****************** -->

            <!-- ****************** -------------- ************************ -------------- ******************
                 ****************** -------------- FACEBOOK SIGN_IN - START -------------- ******************
                 ****************** -------------- ************************ -------------- ****************** -->
            <!--<script async defer crossorigin='anonymous' type='text/javascript'
                    src='https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.3&appId=451407342300123&autoLogAppEvents=1'>
            </script>-->

            <script>
                // Here we run a very simple test of the Graph API after login is
                // successful.  See statusChangeCallback() for when this call is made.

                function sendTokenToServer() {
                    console.log('----------- sendTokenToServer -----------');
                    console.log('FB: ', FB);
                    console.log('FB.getAuthResponse():', FB.getAuthResponse());
                    let access_token = FB.getAuthResponse()['accessToken'];

                    console.log('access_token: ', access_token);
                    console.log('Welcome!  Fetching your information.... ');

                    FB.api('/me', function (response) {
                        console.log('Successful login for: ' + response.name);
                        $.ajax({
                            type: 'POST',
                            url: '/login/facebook?state={{STATE}}',
                            processData: false,
                            data: access_token,
                            contentType: 'application/octet-stream; charset=utf-8',
                            success: function(result) {
                                // Handle or verify the server response if necessary.
                                if (result) {
                                    $('#result').html('<div class="alert-success" role="alert"><strong>Login Successful!</strong>   Redirecting...</div>');
                                    setTimeout(function() {
                                        window.location.href = '/catalog/'  // "/catalog/private";
                                    }, 4000);
                                } else {
                                    $('#result').html('Failed to make a server-side call. Check your configuration and console.');
                                }
                            }
                        });
                    });
                }

                // <!-- FACEBOOK - SIGN_IN -->
                window.fbAsyncInit = function() {
                    console.log('----------- fbAsyncInit *** -----------');
                    FB.init({
                        appId      : '{{ facebook_app_id }}',
                        cookie     : true,  // enable cookies to allow the server to access the session
                        xfbml      : true,  // parse social plugins on this page
                        version    : 'v2.8' // use version 2.8
                    });
                };
                function logout(accessToken) {
                    FB.logout(function (response) {
                        console.log('User logout: ', response)
                    });
                }

                // Load the SDK asynchronously
                (function(d, s, id) {
                    console.log('----------- SDK asynchronously -----------');
                    let js, fjs = d.getElementsByTagName(s)[0];

                    if (d.getElementById(id)) return;

                    js = d.createElement(s); js.id = id;
                    js.src = "https://connect.facebook.net/en_US/sdk.js";
                    fjs.parentNode.insertBefore(js, fjs);
                }(document, 'script', 'facebook-jssdk'));
                // <!-- END FACEBOOK SIGN IN -->
            </script>

            <!--<div class='col col-md-3 align-items-center '>-->
            <button type="button" class="btn btn-outline-secondary" id='signInButton_facebook'>
                <fb:login-button length='long'
                                 size='large'
                                 onlogin="javascript:sendTokenToServer();"
                                 scope="public_profile,email">
                    <span class='align-self-center'>Login with Facebook</span>
                </fb:login-button>
            </button>

            <!--</div> !-- /.col -->
            <!-- ****************** -------------- FACEBOOK SIGN_IN - END -------------- ****************** -->

        </div> <!-- /.row -->
        <div class='row'>

        </div>
    </div> <!-- /.container -->
{% endblock %}
